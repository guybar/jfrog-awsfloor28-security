  build_and_publish_image:
    name: üê≥ Docker Build
    runs-on: ubuntu-latest
    needs: create_image_tag
    permissions:
      contents: read
      actions: write
      id-token: write
      packages: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: üê∏ Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@5b06f730cc5a6f55d78b30753f8583454b08c0aa
        env:
          JF_URL: "https://artifactory.novus.legogroup.io"
          JFROG_CLI_GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN }}
        id: setup-cli
        with:
          oidc-provider-name: icp
          oidc-audience: lego-github
          disable-auto-build-publish: true
      
      - name: ü©ª Scan code
        run: |
          jf audit --format sarif
          
      - name: üß± Build Docker Image
        uses: docker/build-push-action@v6
        with:
          context: src
          file: src/Dockerfile
          push: false
          tags: artifactory.novus.legogroup.io/icp/${{ env.IMAGE }}:${{ needs.create_image_tag.outputs.image_tag }}
          secrets: |
            "github_token=${{ secrets.GITHUB_TOKEN }}"
            "github_username=$GITHUB_ACTOR"
    
      - name: üöÄ Scan image and push if no vulnerabilities found
        run: |
          IMAGE="artifactory.novus.legogroup.io/icp/${{ env.IMAGE }}:${{ needs.create_image_tag.outputs.image_tag }}"
          jf docker scan "$IMAGE" --watches "ALL_REPOS" --format sarif
          jf docker push "$IMAGE"
