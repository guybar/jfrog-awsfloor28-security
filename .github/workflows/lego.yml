name: Verify Successful Build and Test
# on:
#   pull_request:
#     branches:
#       - main
on: workflow_dispatch
env:
  CustomFeedUserName: github
  CustomFeedPassword: ${{ secrets.ICP_GITHUB_PACKAGE_REGISTRY_TOKEN }}
  REGISTRY: artifactory.novus.legogroup.io
  REPO: sf-long-term-simulation-anaplan-integration
  IMAGE: "anaplan-integration"
  WORKING_DIRECTORY: src

jobs:
  create_image_tag:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.image_tag.outputs.IMAGE_TAG }}
    steps:
      - name: Create Image Tag
        id: image_tag
        run: echo "IMAGE_TAG=${GITHUB_REF##*/}-anaplan-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
        
  build_and_publish_image:
    name: üê≥ Docker Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
      id-token: write
      packages: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: üê∏ Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@5b06f730cc5a6f55d78b30753f8583454b08c0aa
        env:
          JF_URL: "https://solengeu.jfrog.io"
          JFROG_CLI_GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN }}
        id: setup-cli
        with:
          oidc-provider-name: guy-github-lego
          oidc-audience: guy-github-lego
          disable-auto-build-publish: true
      
      - name: ü©ª Scan code
        run: |
          jf audit --format sarif
          
      - name: üß± Build Docker Image
        uses: docker/build-push-action@v6
        with:
          context: Source
          file: Source/Dockerfile
          push: false
          tags: solengeu.jfrog.io/guy-docker-dev/lego:
          secrets: |
            "github_token=${{ secrets.GITHUB_TOKEN }}"
            "github_username=$GITHUB_ACTOR"
    
      - name: üöÄ Scan image and push if no vulnerabilities found
        run: |
          IMAGE="solengeu.jfrog.io/guy-docker-dev/lego:"
          jf docker scan "$IMAGE" --watches "ALL_REPOS" --format sarif
          jf docker push "$IMAGE"
